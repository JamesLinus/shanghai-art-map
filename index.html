<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>上海艺术地图</title>
<link rel="stylesheet" type="text/css" href="http://api.amap.com/Public/css/demo.Default.css"/>
<style type="text/css">
    html, body {
        height: 100%;
        margin: 0;
    }
    body {
        overflow:hidden;
    }
    #iCenter {
        min-height: 100%; 
    }
</style>
<!--[if lte IE 6]>
<style type="text/css">
    #container {
        height: 100%;
    }
</style>
<![endif]-->

<script language="javascript" src="http://webapi.amap.com/maps?v=1.2&key=c782dab5eb7efe1269dbc13cd77b9801
"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> 
<script language="javascript">

// http://api.amap.com/javascript/index
// http://api.amap.com/javascript/example
var mapObj;

function addBuildings(){  
    if (typeof(Worker) !== "undefined") {  
        var buildings = new AMap.Buildings(); //实例化3D楼块图层  
        buildings.setMap(mapObj);//在map中添加3D楼块图层  
    } else {
        // document.getElementById("info").innerHTML="对不起，运行该示例需要浏览器支持HTML5！";  
    }  
}  


//添加带文本的点标记覆盖物  
function addMarker(){   
    //自定义点标记内容     
    var markerContent = document.createElement("div");  
    markerContent.className = "markerContentStyle";  
      
    //点标记中的图标  
    var markerImg= document.createElement("img");  
     markerImg.className="markerlnglat";  
     markerImg.src="http://webapi.amap.com/images/0.png";     
     markerContent.appendChild(markerImg);  
       
     //点标记中的文本  
     var markerSpan = document.createElement("span");  
     markerSpan.innerHTML = "我是自定义样式的点标记哦！";  
     markerContent.appendChild(markerSpan);  
     marker = new AMap.Marker({  
        map:mapObj,  
        position:new AMap.LngLat(116.389267,39.925601), //基点位置  
        offset:new AMap.Pixel(-18,-36), //相对于基点的偏移位置  
        draggable:true,  //是否可拖动  
        content:markerContent   //自定义点标记覆盖物内容  
    });  
    marker.setMap(mapObj);  //在地图上添加点  
}

function mapInit(){
    mapObj = new AMap.Map("iCenter", {
        center: new AMap.LngLat(121.473267,31.222715),
        level:  13
    });
    // mapObj.plugin(["AMap.ToolBar"],function(){        
    //     toolBar = new AMap.ToolBar();  
    //     mapObj.addControl(toolBar);       
    // });

    // addBuildings();

    // https://github.com/unixcrh/DOUBANTONGCHENG/blob/master/DouBanTongCheng/ContentVC.m
    var doubanApi = "https://api.douban.com/v2/event/list?loc=shanghai&type=exhibition&max-results=100&callback=?";
    $.getJSON(doubanApi)
        .done(function(json){
            //response json are now in the json variable
            console.log(json);
            json.events.forEach(function(ev, i) {
                var geo = ev.geo.split(' ');
                var marker = new AMap.Marker({
                    map:        mapObj,
                    position:   new AMap.LngLat(geo[1], geo[0]),
                    // icon:       ev.owner.alt.match('site') ? new AMap.Icon({
                    //                 image: ev.owner.avatar,
                    //             }) : null,
                    title:      ev.title + '\n' + 
                                ev.address.replace(/上海(\s+|市)/g, '') + '\n' + 
                                ev.begin_time.substring(5, ev.begin_time.length - 3) + ' ~ ' + 
                                ev.end_time.substring(5, ev.end_time.length - 3)
                });

                // closure based
                // AMap.event.addListener(marker, 'click', function(marker_, i_) {
                //     return function() {
                //         // marker_.setContent(json.events[i_].content);
                //         window.open(json.events[i_].alt,'mywin','');
                //     };
                // }(marker, i));

                AMap.event.addListener(marker, 'click', function() {
                    // marker_.setContent(ev.content);
                    window.open(ev.alt,'mywin','');
                });
            });
        })
        .fail(function() {
            alert('Can not use douban api');
        });    
}

</script>
</head>
<body onLoad="mapInit()">
    <div id="iCenter"></div>
</body>
</html>
